name: Publish to NuGet.org

on:
  # Trigger when a GitHub release is created or published
  release:
    types: [created, published]
  
  # Allow manual trigger with release tag input
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to publish (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  publish-to-nuget:
    runs-on: ubuntu-latest
    
    steps:
      # Setup .NET (needed for dotnet nuget push command)
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      # Debug: Show trigger information
      - name: Debug trigger information
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Event action: ${{ github.event.action }}"
          echo "Release tag: ${{ github.event.release.tag_name }}"
          echo "Release draft: ${{ github.event.release.draft }}"
          echo "Release prerelease: ${{ github.event.release.prerelease }}"
          echo "Release published_at: ${{ github.event.release.published_at }}"
          echo "Release created_at: ${{ github.event.release.created_at }}"
          
      # Download packages from the GitHub release
      - name: Download packages from release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine the release tag
          if [ "${{ github.event_name }}" == "release" ]; then
            RELEASE_TAG="${{ github.event.release.tag_name }}"
          else
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
          fi
          
          echo "Downloading packages from release: $RELEASE_TAG"
          
          # Create directory for packages
          mkdir -p ./packages
          
          # Use GitHub CLI to download release assets
          echo "Listing release assets..."
          gh release view "$RELEASE_TAG" --json assets --jq '.assets[] | select(.name | endswith(".nupkg")) | "\(.name) \(.url)"'
          
          # Download each .nupkg asset using GitHub CLI
          gh release view "$RELEASE_TAG" --json assets --jq '.assets[] | select(.name | endswith(".nupkg")) | .name' | while read -r filename; do
            if [ ! -z "$filename" ]; then
              echo "Downloading: $filename"
              gh release download "$RELEASE_TAG" --pattern "$filename" --dir ./packages/ --clobber
            fi
          done
          
          echo "Downloaded packages:"
          ls -la ./packages/
          
          # Verify packages are valid
          echo "Verifying package sizes:"
          for pkg in ./packages/*.nupkg; do
            if [ -f "$pkg" ]; then
              size=$(stat -c%s "$pkg" 2>/dev/null || stat -f%z "$pkg" 2>/dev/null || echo "unknown")
              echo "$(basename "$pkg"): $size bytes"
              if [ "$size" -lt 1000 ]; then
                echo "WARNING: Package $(basename "$pkg") seems too small ($size bytes)"
                echo "Content preview:"
                head -c 200 "$pkg" | cat -v
              fi
            fi
          done
      
      # Publish to NuGet.org
      - name: Publish to NuGet.org
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          # Check if API key is configured
          if [ -z "$NUGET_API_KEY" ]; then
            echo "Error: NUGET_API_KEY secret is not configured"
            echo "Please add your NuGet.org API key as a repository secret"
            exit 1
          fi
          
          # Push each package to NuGet.org
          for package in ./packages/*.nupkg; do
            if [[ -f "$package" ]] && [[ ! "$package" == *.symbols.nupkg ]]; then
              echo "Publishing to NuGet.org: $(basename $package)"
              dotnet nuget push "$package" \
                --source "https://api.nuget.org/v3/index.json" \
                --api-key "$NUGET_API_KEY" \
                --skip-duplicate \
                || echo "Warning: Failed to push $(basename $package) - it may already exist"
            fi
          done
      
      # Summary
      - name: Summary
        run: |
          echo "## ðŸ“¦ NuGet.org Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "### Triggered by Release" >> $GITHUB_STEP_SUMMARY
            echo "- **Release**: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Release URL**: ${{ github.event.release.html_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Manual Trigger" >> $GITHUB_STEP_SUMMARY
            echo "- **Release Tag**: ${{ github.event.inputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
          echo "The following packages have been published to NuGet.org:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for package in ./packages/*.nupkg; do
            if [[ -f "$package" ]] && [[ ! "$package" == *.symbols.nupkg ]]; then
              echo "- âœ… $(basename $package)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### View on NuGet.org" >> $GITHUB_STEP_SUMMARY
          echo "Packages should be available at: https://www.nuget.org/profiles/${{ github.repository_owner }}" >> $GITHUB_STEP_SUMMARY
