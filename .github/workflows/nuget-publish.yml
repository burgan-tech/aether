name: Build and Publish NuGet Packages

on:
  push:
    branches:
      - 'release-v*'
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish packages even if version exists'
        required: false
        default: false
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'
  NUGET_OUTPUT_DIRECTORY: './nupkg'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for proper versioning

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Calculate version from branch name
      id: version
      run: |
        BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        echo "Branch name: $BRANCH_NAME"
        
        # Extract base version from branch name (e.g., release-v1.0 -> 1.0)
        if [[ $BRANCH_NAME =~ ^release-v([0-9]+\.[0-9]+)$ ]]; then
          BASE_VERSION="${BASH_REMATCH[1]}"
          echo "Base version from branch: $BASE_VERSION"
          
          # Check if packages with this version pattern already exist on GitHub Packages
          MAJOR_MINOR="$BASE_VERSION"
          FULL_VERSION="${MAJOR_MINOR}.0"
          
          # Function to check if version exists on GitHub Packages
          check_version_exists() {
            local package_name=$1
            local version=$2
            # Use GitHub API to check if package version exists
            local response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/orgs/${{ github.repository_owner }}/packages/nuget/${package_name,,}/versions" \
              | jq -r '.[] | select(.name == "'$version'") | .name' 2>/dev/null || echo "")
            if [ -n "$response" ]; then
              return 0  # Version exists
            else
              return 1  # Version doesn't exist
            fi
          }
          
          # Find the next available patch version
          PATCH=0
          while true; do
            TEST_VERSION="${MAJOR_MINOR}.${PATCH}"
            echo "Checking if version $TEST_VERSION exists for BBT.Aether.Core..."
            
            if check_version_exists "BBT.Aether.Core" "$TEST_VERSION"; then
              echo "Version $TEST_VERSION already exists, trying next patch version..."
              PATCH=$((PATCH + 1))
            else
              FULL_VERSION="$TEST_VERSION"
              echo "Version $FULL_VERSION is available!"
              break
            fi
            
            # Safety check to prevent infinite loop
            if [ $PATCH -gt 100 ]; then
              echo "Too many patch versions, using $TEST_VERSION anyway"
              FULL_VERSION="$TEST_VERSION"
              break
            fi
          done
          
          VERSION="$FULL_VERSION"
        else
          echo "Branch name doesn't match release-vX.Y pattern, falling back to common.props"
          VERSION=$(grep -oP '<Version>\K[^<]+' common.props)
        fi
        
        echo "Final calculated version: $VERSION"
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

    - name: Update version in common.props
      run: |
        echo "Updating common.props with version ${{ steps.version.outputs.VERSION }}"
        # Create backup
        cp common.props common.props.backup
        
        # Update version in common.props
        sed -i.bak "s|<Version>.*</Version>|<Version>${{ steps.version.outputs.VERSION }}</Version>|g" common.props
        
        # Verify the change
        echo "Updated version in common.props:"
        grep "<Version>" common.props

    - name: Restore dependencies
      run: |
        dotnet restore framework/BBT.Aether.sln
        

    - name: Build solution
      run: |
        dotnet build framework/BBT.Aether.sln --configuration Release --no-restore
       

    - name: Run tests
      run: |
        dotnet test framework/BBT.Aether.sln --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage"
        
    - name: Create NuGet packages
      run: |
        # Create output directory
        mkdir -p ${{ env.NUGET_OUTPUT_DIRECTORY }}
        
        # Framework packages
        dotnet pack framework/src/BBT.Aether.Core/BBT.Aether.Core.csproj --configuration Release --no-build --output ${{ env.NUGET_OUTPUT_DIRECTORY }}
        dotnet pack framework/src/BBT.Aether.Domain/BBT.Aether.Domain.csproj --configuration Release --no-build --output ${{ env.NUGET_OUTPUT_DIRECTORY }}
        dotnet pack framework/src/BBT.Aether.Application/BBT.Aether.Application.csproj --configuration Release --no-build --output ${{ env.NUGET_OUTPUT_DIRECTORY }}
        dotnet pack framework/src/BBT.Aether.Infrastructure/BBT.Aether.Infrastructure.csproj --configuration Release --no-build --output ${{ env.NUGET_OUTPUT_DIRECTORY }}
        dotnet pack framework/src/BBT.Aether.AspNetCore/BBT.Aether.AspNetCore.csproj --configuration Release --no-build --output ${{ env.NUGET_OUTPUT_DIRECTORY }}
        dotnet pack framework/src/BBT.Aether.TestBase/BBT.Aether.TestBase.csproj --configuration Release --no-build --output ${{ env.NUGET_OUTPUT_DIRECTORY }}
        dotnet pack framework/src/BBT.Aether.HttpClient/BBT.Aether.HttpClient.csproj --configuration Release --no-build --output ${{ env.NUGET_OUTPUT_DIRECTORY }}
        
    - name: List created packages
      run: |
        echo "Created NuGet packages:"
        ls -la ${{ env.NUGET_OUTPUT_DIRECTORY }}/*.nupkg

    - name: Upload packages as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages-${{ steps.version.outputs.VERSION }}
        path: ${{ env.NUGET_OUTPUT_DIRECTORY }}/*.nupkg

    - name: Publish to GitHub Packages
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Push directly to GitHub Packages with authentication
        for package in ${{ env.NUGET_OUTPUT_DIRECTORY }}/*.nupkg; do
          echo "Publishing $package to GitHub Packages..."
          if [ "${{ github.event.inputs.force_publish }}" = "true" ]; then
            dotnet nuget push "$package" \
              --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
              --api-key ${{ secrets.GITHUB_TOKEN }} \
              --skip-duplicate
          else
            dotnet nuget push "$package" \
              --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" \
              --api-key ${{ secrets.GITHUB_TOKEN }} \
              --skip-duplicate
          fi
        done

    - name: Create GitHub Release
      if: success() && startsWith(github.ref, 'refs/heads/release-v')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        TAG_NAME="v${VERSION}"
        RELEASE_NAME="Release v${VERSION}"
        
        # Check if this is a pre-release
        if [[ "$VERSION" =~ -(alpha|beta|rc|preview) ]]; then
          PRERELEASE_FLAG="--prerelease"
        else
          PRERELEASE_FLAG=""
        fi
        
        # Create release notes
        cat > release_notes.md << EOF
        ## Changes in v${VERSION}
        
        This release includes updates to the Aether framework.
        
        ### Published NuGet Packages:
        - BBT.Aether.Core v${VERSION}
        - BBT.Aether.Domain v${VERSION}
        - BBT.Aether.Application v${VERSION}
        - BBT.Aether.Infrastructure v${VERSION}
        - BBT.Aether.AspNetCore v${VERSION}
        - BBT.Aether.TestBase v${VERSION}
        - BBT.Aether.HttpClient v${VERSION}
   
        
        ### Installation
        \`\`\`bash
        dotnet add package BBT.Aether.Core --version ${VERSION}
        \`\`\`
        
        **Full Changelog**: ${{ github.event.repository.html_url }}/compare/${TAG_NAME}...HEAD
        EOF
        
        # Create the release
        gh release create "$TAG_NAME" \
          --title "$RELEASE_NAME" \
          --notes-file release_notes.md \
          $PRERELEASE_FLAG \
          ${{ env.NUGET_OUTPUT_DIRECTORY }}/*.nupkg
        
        echo "âœ… Created GitHub release: $RELEASE_NAME"

    - name: Notify on success
      if: success()
      run: |
        echo "âœ… Successfully published NuGet packages for version ${{ steps.version.outputs.VERSION }}"
        echo "ðŸ“¦ Packages are available at: https://github.com/${{ github.repository }}/packages"

    - name: Restore original common.props
      if: always()
      run: |
        if [ -f common.props.backup ]; then
          echo "Restoring original common.props"
          mv common.props.backup common.props
        fi

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Failed to publish NuGet packages"
        echo "Check the logs above for detailed error information"
