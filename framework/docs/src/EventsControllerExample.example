using System.Threading;
using System.Threading.Tasks;
using BBT.Aether.Events;
using BBT.Aether.Uow;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

namespace BBT.Aether.AspNetCore.Events;

/// <summary>
/// Example implementation of EventsController showing how to create a concrete controller
/// with custom routes and optional method overrides.
/// 
/// Usage in your project:
/// 1. Create a new controller class that inherits from EventsController
/// 2. Add [ApiController] and [Route] attributes to define your endpoints
/// 3. Create an action method that calls ProcessEventAsync()
/// 4. Optionally override virtual methods to customize behavior
/// </summary>
[ApiController]
[Route("api/events/{name}/v{version:int}")]
public sealed class EventsControllerExample(
    IDistributedEventInvokerRegistry invokerRegistry,
    IInboxStore inboxStore,
    IUnitOfWorkManager unitOfWorkManager,
    IServiceProvider serviceProvider,
    IEventSerializer serializer,
    ILogger<EventsControllerExample> logger) 
    : EventsController(invokerRegistry, inboxStore, unitOfWorkManager, serviceProvider, serializer, logger)
{
    /// <summary>
    /// Handles incoming events from Dapr.
    /// This action simply delegates to the base ProcessEventAsync method.
    /// </summary>
    /// <param name="name">Event name from route</param>
    /// <param name="version">Event version from route</param>
    /// <param name="cancellationToken">Cancellation token</param>
    [HttpPost]
    public async Task<IActionResult> Post(
        [FromRoute] string name,
        [FromRoute] int version,
        CancellationToken cancellationToken)
    {
        return await ProcessEventAsync(name, version, cancellationToken);
    }

    // Example: Override virtual methods to customize behavior
    // Uncomment and modify as needed:

    // protected override async Task<byte[]> ReadRequestBodyAsync(CancellationToken cancellationToken)
    // {
    //     // Custom request body reading logic
    //     return await base.ReadRequestBodyAsync(cancellationToken);
    // }

    // protected override string? TryExtractEventId(byte[] payload, string name, int version)
    // {
    //     // Custom event ID extraction logic
    //     return base.TryExtractEventId(payload, name, version);
    // }

    // protected override async Task TryMarkEventAsProcessedAsync(byte[] payload, string eventId, CancellationToken cancellationToken)
    // {
    //     // Custom inbox marking logic
    //     await base.TryMarkEventAsProcessedAsync(payload, eventId, cancellationToken);
    // }

    // protected override async Task<IActionResult> ProcessEventAsync(string name, int version, CancellationToken cancellationToken)
    // {
    //     // Custom pre-processing logic here
    //     var result = await base.ProcessEventAsync(name, version, cancellationToken);
    //     // Custom post-processing logic here
    //     return result;
    // }
}

